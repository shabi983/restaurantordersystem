<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css?v=1.0.5">
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
  <meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Client Portal">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="https://abihasofto.xyz/CPAS/demo/icon-512.png" type="image/png">
  <link rel="apple-touch-icon" sizes="152x152" href="https://abihasofto.xyz/CPAS/demo/icon-512.png">
 <meta name="theme-color" content="#0097e1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js?v=1.0.8"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
  font-family: Arial, sans-serif;
  margin: 0;
  background: #f4f4f4;
  overflow-x: hidden; /* ðŸ‘ˆ prevent page-wide horizontal scroll */
}

    .container { max-width: 1000px; margin: auto; padding: 20px; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    table, th, td { border: 1px solid #ccc; }
    th, td { padding: 8px; text-align: left; }
    select, button.action-btn { padding: 5px; }
    .loader-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center; z-index: 999; }
    .loader { border: 6px solid #f3f3f3; border-top: 6px solid #0097e1; border-radius: 50%; width: 100px; height: 100px; animation: spin 1s linear infinite; }
    .hidden { display: none !important; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }


.custom-scrollbar::-webkit-scrollbar {
  height: 6px;
}
.custom-scrollbar::-webkit-scrollbar-track {
  background: #f1f1f1;
}
.custom-scrollbar::-webkit-scrollbar-thumb {
  background-color: #0097e1;
  border-radius: 5px;
}
.custom-scrollbar::-webkit-scrollbar-thumb:hover {
  background-color: #0056b3;
}
.custom-scrollbar {
  scrollbar-width: thin;
  scrollbar-color: #0097e1 #f1f1f1;
}


      .sidebar-transition {
      transition: transform 0.3s ease-in-out, width 0.3s ease-in-out;
    }
    .content-transition {
      transition: margin-left 0.3s ease-in-out;
    }


  </style>

</head>
<body class="bg-gray-100">

  <!-- Topbar (All Devices) -->
  <div class="text-white sticky top-0 z-[99999] flex items-center justify-between px-4 py-3 bg-[#0097e1]" >
  <div class="text-xl font-bold"><img style="width:70px;" src="https://abihasofto.xyz/CPAS/demo/loading.png" alt="Abiha Softo"></div>
    <div class="text-xl font-bold">Admin Panel</div>
    <button onclick="toggleSidebar()" class="space-y-1">
      <i class="fa fa-bars text-2xl"></i>
    </button>
  </div>

  <div class="flex">

    <!-- Sidebar -->
    <aside id="sidebar"
      class="sidebar-transition fixed top-0 left-0 h-full bg-[#0097e1] text-white p-4 space-y-4 w-64 overflow-hidden lg:fixed z-40 h-screen">

      <div id="sidebarContent">

  <img style="width:70px;" src="https://abihasofto.xyz/CPAS/demo/loading.png" alt="Abiha Softo">
  
  <a onclick="showTab('dashboard')" id="tab-dashboard" class="block py-2 px-4 hover:bg-[#0056b3] rounded cursor-pointer m-5">Dashboard</a>

  <a onclick="showTab('users')" id="tab-users" class="block py-2 px-4 bg-[#0056b3] rounded cursor-pointer m-5">Users</a>     

  <a onclick="showTab('menu')" id="tab-menu" class="block py-2 px-4 hover:bg-[#0056b3] rounded cursor-pointer m-5">Menu</a>

  <a onclick="showTab('orders')" id="tab-orders" class="relative block py-2 px-4 hover:bg-[#0056b3] rounded cursor-pointer m-5">
  Orders<i id="submissionsDot" class="fa fa-bell hidden absolute top-3 right-1 text-yellow-400" aria-hidden="true"></i></a> 

 <div class="p-2 rounded-lg w-full max-w-md text-center space-y-4">
    
    <!-- QR Code -->
    <canvas id="qr" class="mx-auto"></canvas>
    <h2 class="text-l uppercase font-bold mb-2">Share User Link</h2>

    <!-- Link & Copy Section -->
    <div class="relative">
      <input id="linkInput" type="text" readonly
        class="w-full border rounded p-2 pr-20 text-center text-blue-600 font-medium cursor-pointer"
        value="google.com" onclick="copyLink()" />
      <button onclick="copyLink()" class="absolute right-2 top-1/2 -translate-y-1/2 bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 text-sm">
        Copy
      </button>
    </div>

    <!-- Copied Text -->
    <p id="copiedMsg" class="text-white-600 font-bold hidden">Link Copied!</p>
  </div>

         <span class="text-white-600 text-sm fixed" style="bottom: 5px;"><i>Version 1.0.0</i></span>
      </div>
    </aside>

    <!-- Overlay for mobile/tablet -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-30" onclick="toggleSidebar()"></div>

    <!-- Main content -->
    <main id="mainContent" class="flex-1 p-6 content-transition lg:ml-64 overflow-x-hidden">

  <div id="loader" class="loader-backdrop hidden">
    <img style=" max-width: 88px; position: fixed;" src="https://abihasofto.xyz/CPAS/demo/loading.png" alt="Abiha Softo">
  <div class="loader">
  </div>
</div>
         <div bis_skin_checked="1" class="flex justify-between">
       <h1 class="text-xl font-bold mb-6 mt-6">Welcome: <span id="adminName" class=" text-green-400 font-thin"></span></h1>
       <button onclick="hardRefresh()" style="color:#0097e1; border:none;"><i class="fa fa-refresh transition-transform duration-300 hover:animate-spin cursor-pointer text-xl" onclick="hardRefresh()" title="Refresh"></i></button></div>
      
    <button onclick="logout()" style="position: fixed; bottom: 10px; right: 10px; background: red; color: white; padding: 8px; border: none; border-radius: 4px; cursor: pointer;">Logout</button>
  <div class="container overflow-x-hidden">


<div id="adminContent" class="bg-white p-4 rounded shadow overflow-x-auto">Loading...</div>

  

</div>

<!-- Modal -->
<div id="modalBackdrop" class="justify-items-center content-center fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6" id="modalContent">
    <h2 class="text-lg font-bold mb-4" id="modalTitle">Edit</h2>
    <div id="modalBody"></div>
    <div class="flex justify-end gap-2 mt-4">
      <button onclick="closeModal()" class="bg-red-100 hover:bg-red-600  text-black px-4 py-1 rounded">Cancel</button>
      <button onclick="saveModalData()" class="bg-[#0097e1] hover:bg-blue-600  text-white px-4 py-1 rounded">Save</button>
    </div>
  </div>
</div>

    </main>


<script>
  let sidebarOpen = window.innerWidth >= 1024;

  function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const sidebarContent = document.getElementById('sidebarContent');
    const overlay = document.getElementById('overlay');
    const mainContent = document.getElementById('mainContent');

    sidebar.classList.toggle('w-64');
    sidebar.classList.toggle('w-0');
    sidebar.classList.toggle('-translate-x-full');

    sidebarContent.classList.toggle('opacity-0');
    sidebarContent.classList.toggle('pointer-events-none');

    if (window.innerWidth >= 1024) {
      mainContent.classList.toggle('lg:ml-64');
    } else {
      overlay.classList.toggle('hidden');
    }

    sidebarOpen = !sidebarOpen;
  }

  // âœ… Fix: ensure sidebar stays hidden on mobile/tab when page loads
  document.addEventListener('DOMContentLoaded', () => {
    if (window.innerWidth < 1024) {
      const sidebar = document.getElementById('sidebar');
      const sidebarContent = document.getElementById('sidebarContent');
      const overlay = document.getElementById('overlay');

      sidebar.classList.add('-translate-x-full');
      sidebar.classList.add('w-0');
      sidebar.classList.remove('w-64');

      sidebarContent.classList.add('opacity-0');
      sidebarContent.classList.add('pointer-events-none');

      overlay.classList.add('hidden');
    }
  });
</script>



<script>
const API_URL = "https://script.google.com/macros/s/AKfycby_dcdxa11mxd14S1Uvd7m9hQR-FKgGh3jYMu0emhBFiw5FAbpM7oa7smACeZUJQMod0A/exec";
let modalType = "", modalData = null;
let liveRefreshEnabled = false; // <== This was missing!

showLoader(true);

function logout() {
  localStorage.clear();
  window.location.href = "index.html";
}

function showLoader(show) {
  document.getElementById("loader").classList.toggle("hidden", !show);
}

function showTab(tab) {
  currentTab = tab;
  localStorage.setItem("lastTab", tab);

  // âœ… Remove active highlight from all tabs
  document.querySelectorAll("#sidebarContent a").forEach(link => {
    link.classList.remove("bg-[#0056b3]", "font-semibold");
  });

  // âœ… Add active highlight to selected tab
  const activeLink = document.getElementById(`tab-${tab}`);
  if (activeLink) {
    activeLink.classList.add("bg-[#0056b3]", "font-semibold");
  }

  // Load tab-specific content
  if (tab === "orders") loadOrders();
  if (tab === "menu") loadMenu();
  if (tab === "users") loadUsers();
}



function loadUsers() {
  showLoader(true);
  fetch(`${API_URL}?action=getUsers`)
    .then(res => res.json())
    .then(data => {
      let html = `
        <div class="grid grid-cols-1 sm:grid-cols-1 md:grid-cols-3 lg:grid-cols-3 gap-4 mb-4">
          <h2 class="text-2xl font-semibold">Users</h2>
              <input type="text" onkeyup="filterUsers(this.value)" placeholder="Search by username..." 
      class="w-full md:w-100 px-4 py-2 border rounded shadow-sm outline-none" />
          <button onclick="showAddUserForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
            + Add User
          </button>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
      `;

      data.forEach(u => {
        html += `
          <div class="bg-white shadow rounded p-4 border border-gray-200">
            <div class="mb-2">
              <span class="font-medium">Username:</span>
              <span class="block text-gray-800 break-all">${u.username}</span>
            </div>
            <div class="mb-2">
              <span class="font-medium">Password:</span>
              <span class="block text-gray-600 break-all">${u.password}</span>
            </div>
            <div class="mb-4">
              <span class="font-medium">Role:</span>
              <span class="block text-gray-700 capitalize">${u.role}</span>
            </div>
            <div class="flex space-x-2">
              <button onclick='openModal("user", ${JSON.stringify(u)})' class="bg-[#0097e1] hover:bg-blue-600 text-white px-3 py-1 rounded">
                Edit
              </button>
              <button onclick='deleteUser("${u.username}")' class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded">
                Delete
              </button>
            </div>
          </div>
        `;
      });

      html += `</div>`;
      document.getElementById("adminContent").innerHTML = html;
      showLoader(false);
    });
}

function filterUsers(query) {
  const cards = document.querySelectorAll('#adminContent .grid > div');
  const lowerQuery = query.toLowerCase();

  cards.forEach(card => {
    const usernameEl = card.querySelector('span.block'); // username is always the first <span class="block ...">
    const username = usernameEl?.textContent.toLowerCase() || '';
    if (username.includes(lowerQuery)) {
      card.style.display = '';
    } else {
      card.style.display = 'none';
    }
  });
}

function filterUsers(query) {
  const cards = document.querySelectorAll('#adminContent .grid > div');
  const lowerQuery = query.toLowerCase();

  cards.forEach(card => {
    const text = card.innerText.toLowerCase();
    card.style.display = text.includes(lowerQuery) ? '' : 'none';
  });
}


function showAddUserForm() {
  document.getElementById("adminContent").innerHTML = `
    <h3 class="text-lg font-semibold mb-2">Add New User</h3>
    <input id="newUser" class="border p-1 mb-2 block w-full" placeholder="Username">
    <input id="newPass" class="border p-1 mb-2 block w-full" placeholder="Password">
    <select id="newRole" class="border p-1 mb-2 block w-full">
      <option value="admin">Admin</option>
      <option value="user">User</option>
    </select>
    <button onclick="addUser()" class="bg-[#0097e1] hover:bg-blue-600  text-white px-3 py-1 rounded">Save</button>
  `;
}

function addUser() {
   fetch(API_URL, {
    method: "POST",
    body: new URLSearchParams({
      action: "addUser",
      username: document.getElementById("newUser").value,
      password: document.getElementById("newPass").value,
      role: document.getElementById("newRole").value
    })
  }).then(() => showTab("users"));
}

function deleteUser(username) {
  
  if (!confirm("Delete user?")) return;
  fetch(API_URL, {
    method: "POST",
    body: new URLSearchParams({ action: "deleteUser", username }) 
  }).then(() => showTab("users")); 
}


// ========== MENU ==========
function loadMenu() {
   showLoader(true);
  fetch(`${API_URL}?action=getMenu`)
    .then(res => res.json())
    .then(data => {
      let html = `
          <div class="grid grid-cols-1 sm:grid-cols-1 md:grid-cols-3 lg:grid-cols-3 gap-4 mb-4">
          <h2 class="text-2xl font-semibold">Menu</h2>
              <input type="text" onkeyup="filterUsers(this.value)" placeholder="Search by items name..." 
      class="w-full md:w-100 px-4 py-2 border rounded shadow-sm outline-none" />
          <button onclick="showAddMenuForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">+ Add Item</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      `;
      data.forEach(item => {
        const image = item.Image
          ? (item.Image.includes("drive.google.com")
              ? `<iframe src="${item.Image}" class="w-full h-40 rounded mb-2" frameborder="0" allowfullscreen></iframe>`
              : `<img src="${item.Image}" class="w-full h-40 rounded mb-2 object-cover" alt="Menu Image">`)
          : `<div class="w-full h-40 bg-gray-200 flex items-center justify-center text-sm text-gray-400 mb-2 rounded">No Image</div>`;

        html += `
          <div class="bg-white p-4 border rounded shadow">
            ${image}
            <h3 class="text-lg font-bold">${item["Item Name"]}</h3>
            <p>Category: ${item.Category}</p>
            <p>Price: $ ${item.Price}</p>
            <p>Sauces: ${item.Sauces || "-"}</p>
            <p>Extras: ${item.Extras || "-"}</p>
            <div class="mt-2 flex justify-between">
              <button onclick='openModal("menu", ${JSON.stringify(item)})' class="bg-[#0097e1] hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">Edit</button>
              <button onclick='deleteMenuItem("${item.ID}")' class="bg-red-600 hover:bg-red-700  text-white px-3 py-1 rounded text-sm">Delete</button>
            </div>
          </div>
        `;
      });
      html += `</div>`;
      document.getElementById("adminContent").innerHTML = html;
      showLoader(false);
    });

}

function showAddMenuForm() {
  document.getElementById("adminContent").innerHTML = `
    <h3 class="text-lg font-semibold mb-2">Add Menu Item</h3>
    <input id="m_id" class="border p-1 mb-2 block w-full" placeholder="ID">
    <input id="m_name" class="border p-1 mb-2 block w-full" placeholder="Item Name">
    <input id="m_price" class="border p-1 mb-2 block w-full" placeholder="Price">
    <input id="m_cat" class="border p-1 mb-2 block w-full" placeholder="Category">
    <input id="m_sauce" class="border p-1 mb-2 block w-full" placeholder="Sauces (comma)">
    <input id="m_extra" class="border p-1 mb-2 block w-full" placeholder="Extras (comma)">
    
    <label class="block mt-2">Upload Image (optional):</label>
    <input type="file" id="m_image" accept="image/*" class="block mt-1 mb-2">

    <label class="block mt-2">Or Image URL (optional):</label>
    <input type="text" id="m_image_url" class="border p-1 block w-full mb-4" placeholder="https://...">

    <button onclick="addMenuItem()" class="bg-[#0097e1] hover:bg-blue-600 text-white px-3 py-1 rounded">Save</button>
  `;
  
}

function addMenuItem() {
  const fileInput = document.getElementById("m_image");
  const file = fileInput.files[0];
  const url = document.getElementById("m_image_url").value.trim();

  // âœ… Prevent both being filled at the same time
  if (file && url) {
    alert("âŒ Please upload a file OR paste a URL â€” not both.");
    return;
  }

  // ðŸ“¤ Handle file upload
  if (file) {
    const reader = new FileReader();
    reader.onload = function (e) {
      const base64 = e.target.result;
      sendAddMenuData(base64, "");
    };
    reader.readAsDataURL(file);
  } else {
    // ðŸŒ Handle external image URL or no image
    sendAddMenuData("", url);
  }

}

function sendAddMenuData(imageBase64, imageUrl) {
  showLoader(true);
  fetch(API_URL, {
    method: "POST",
    body: new URLSearchParams({
      action: "addMenuItem",
      id: document.getElementById("m_id").value,
      itemName: document.getElementById("m_name").value,
      price: document.getElementById("m_price").value,
      category: document.getElementById("m_cat").value,
      sauces: document.getElementById("m_sauce").value,
      extras: document.getElementById("m_extra").value,
      image: imageBase64,
      imageUrl: imageUrl
    })
  }).then(() => showTab("menu"));
  showLoader(false);
}


function deleteMenuItem(id) {
  if (!confirm("Delete menu item?")) return;
  fetch(API_URL, {
    method: "POST",
    body: new URLSearchParams({
      action: "deleteMenuItem",  // âœ… Must match code.gs exactly
      id                        // âœ… This must be the item's ID (first column)
    })
  }).then(() =>  showTab("menu"));
}



// ========== ORDERS ==========
function loadOrders(silent = false, searchQuery = "") {
  showLoader(true);
  fetch(`${API_URL}?action=getOrders`, { noLoader: silent })
    .then(res => res.json())
    .then(data => {
        if (searchQuery) {
    data = data.filter(order =>
      order["Order ID"]?.toLowerCase().includes(searchQuery.toLowerCase())
    );
  }
let html = `
  <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
    <h2 class="text-xl font-semibold">Orders</h2>
          <label class="flex items-center gap-2 text-sm">
        <span>Live Preview:</span>
        <input type="checkbox" id="liveToggle" onchange="toggleLivePreview()" class="accent-[#0097e1]">
      </label>
    
<div class="grid lg:grid-cols-2 md:grid-cols-2 sm:grid-cols-1 gap-1 items-center">
  <input
    type="text"
    id="orderSearch"
    placeholder="Search Order ID..."
    class="border px-2 py-1 rounded text-sm outline-none"
    oninput="handleOrderSearch(this.value)"
  />
  <button onclick="clearOrderSearch()" class="text-white bg-red-600 hover:bg-red-700  text-sm px-2 py-1">Reset</button>
</div>

  </div>
`;
      if (data.length === 0) {
        html += `<div class="text-center text-gray-500 mt-4 italic">No orders yet.</div>`;
      } else {
        html += `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">`;

        data.forEach(order => {
          const items = JSON.parse(order.Items || "[]").map(item => {
            return `
              <li class="text-sm mb-1">
                <strong>${item.name}</strong><br>
                ${item.sauces?.length ? `Sauce: ${item.sauces.join(", ")}<br>` : ""}
                ${item.extras?.length ? `Extra: ${item.extras.join(", ")}<br>` : ""}
                $ ${item.price}
              </li>
            `;
          }).join("");

          const currentStatus = order.Status || "";

          html += `
            <div class="bg-white p-4 shadow rounded border relative">
              <div class="absolute top-2 right-2 text-xs font-mono text-gray-400">${order["Order ID"]}</div>
              <h3 class="text-lg font-bold mb-1">ðŸ‘¤ ${order.User}</h3>
              <ul class="mb-2">${items}</ul>
              <p class="text-sm text-gray-700 mb-1">ðŸ’¬ ${order.Notes || "No notes"}</p>
              <p class="text-right font-bold text-green-600">Total: $ ${order.Total}</p>
              <p class="text-right text-xs text-gray-400">${new Date(order.Date).toLocaleString()}</p>

<div class="mt-2 text-sm">
    <label class="font-medium mr-2">Status:</label>
    <select
  onfocus="pauseLiveRefresh()"
  onchange="updateOrderStatus('${order["Order ID"]}', this.value); resumeLiveRefresh();" class="border rounded px-2 py-1">
      <option value="">Select Status</option>
      <option value="Processing" ${currentStatus === "Processing" ? "selected" : ""}>Processing</option>
      <option value="Baking" ${currentStatus === "Baking" ? "selected" : ""}>Baking</option>
      <option value="Delivered" ${currentStatus === "Delivered" ? "selected" : ""}>Delivered</option>
    </select>
  </div>

              <div class="flex justify-end mt-2">
                <button onclick='deleteOrder("${order["Order ID"]}")' class="bg-red-600 hover:bg-red-700  text-white px-3 py-1 rounded text-sm">Delete</button>
              </div>
            </div>`;
        });

        html += `</div>`;
      }

      document.getElementById("adminContent").innerHTML = html;
      showLoader(false);
    }); // this .then()
} // âœ… ADD THIS MISSING BRACKET


function updateOrderStatus(orderId, status) {
  if (!status) return; // prevent sending if no status selected

  fetch(API_URL, {
    method: "POST",
    body: new URLSearchParams({
      action: "updateOrderStatus",
      id: orderId,
      status: status
    })
  })
    .then(res => res.text())
    .then(msg => {
      console.log("âœ… Status updated:", msg);
    })
    .catch(err => {
      alert("âŒ Failed to update status");
      console.error(err);
    });
}



function deleteOrder(id) {
  if (!confirm("Delete order?")) return;
 fetch(API_URL, {
    method: "POST",
    body: new URLSearchParams({ action: "deleteOrder", id })
  }).then(() => showTab("orders"));
}

// ===== MODAL =====
function openModal(type, data) {
  modalType = type;
  modalData = data;
  document.getElementById("modalBackdrop").classList.remove("hidden");

  if (type === "user") {
    document.getElementById("modalTitle").innerText = "Edit User";
    document.getElementById("modalBody").innerHTML = `
      <input id="m_username" class="border p-1 mb-2 w-full" value="${data.username}" disabled>
      <input id="m_password" class="border p-1 mb-2 w-full" value="${data.password}">
      <select id="m_role" class="border p-1 mb-2 w-full">
        <option value="admin" ${data.role === "admin" ? "selected" : ""}>Admin</option>
        <option value="user" ${data.role === "user" ? "selected" : ""}>User</option>
      </select>`;
  }

if (type === "menu") {
  document.getElementById("modalTitle").innerText = "Edit Menu Item";
document.getElementById("modalBody").innerHTML = `
  <input id="m_id" class="border p-1 mb-2 w-full" value="${modalData.ID}" disabled>
  <input id="m_name" class="border p-1 mb-2 w-full" value="${modalData["Item Name"]}">
  <input id="m_price" class="border p-1 mb-2 w-full" value="${modalData.Price}">
  <input id="m_cat" class="border p-1 mb-2 w-full" value="${modalData.Category}">
  <input id="m_sauce" class="border p-1 mb-2 w-full" value="${modalData.Sauces}">
  <input id="m_extra" class="border p-1 mb-2 w-full" value="${modalData.Extras}">

  <label class="block mt-2">Upload New Image:</label>
  <input type="file" id="m_image" accept="image/*" class="block mt-1">
  <label class="block mt-2">Or Image URL:</label>
  <input id="m_image_url" type="text" class="border p-1 mt-1 w-full" placeholder="https://..." value="${modalData.Image || ''}">
`;

}

}

function closeModal() {
  document.getElementById("modalBackdrop").classList.add("hidden");
}

function saveModalData() {
  if (modalType === "user") {
    fetch(API_URL, {
      method: "POST",
      body: new URLSearchParams({
        action: "updateUser",
        username: modalData.username,
        password: document.getElementById("m_password").value,
        role: document.getElementById("m_role").value
      })
    }).then(() => {
      closeModal();
      currentTab = "users";
      showTab("users");

    });
  }

  if (modalType === "menu") {
    const id = document.getElementById("m_id").value;
    const itemName = document.getElementById("m_name").value;
    const price = document.getElementById("m_price").value;
    const category = document.getElementById("m_cat").value;
    const sauces = document.getElementById("m_sauce").value;
    const extras = document.getElementById("m_extra").value;
    const imageUrl = document.getElementById("m_image_url").value;
    const imageFile = document.getElementById("m_image").files[0];
    
    if (imageFile) {
      const reader = new FileReader();
      reader.onload = function (e) {
        const imageBase64 = e.target.result;

        sendMenuUpdate({
          id,
          itemName,
          price,
          category,
          sauces,
          extras,
          imageUrl,
          imageBase64
        });
      };
      reader.readAsDataURL(imageFile);
    } else {
      sendMenuUpdate({
        id,
        itemName,
        price,
        category,
        sauces,
        extras,
        imageUrl,
        imageBase64: "", // no new upload
      });
    }
  }
}

function sendMenuUpdate(data) {
  console.log("ðŸ“¤ Sending menu update:", data); // DEBUG log
  fetch(API_URL, {
    method: "POST",
    body: new URLSearchParams({
      action: "updateMenuItem",
      id: data.id,
      itemName: data.itemName,
      price: data.price,
      category: data.category,
      sauces: data.sauces,
      extras: data.extras,
      imageUrl: data.imageUrl,
      image: data.imageBase64
    })
  })
    .then(res => res.text())
    .then((resp) => {
      console.log("âœ… Server response:", resp); // DEBUG log
      closeModal();
      showTab("menu");
    });
}


// ===== SESSION CHECK =====
window.addEventListener("DOMContentLoaded", () => {
  const token = localStorage.getItem("session");
  const role = localStorage.getItem("role");
  const userIP = "unknown";
  const nameSpan = document.getElementById("adminName");
  const username = localStorage.getItem("username");

  if (!token || !role) {
    window.location.href = "index.html";
  } else {
    fetch(`${API_URL}?action=checkSession&token=${token}&ip=${userIP}`)
      .then(res => res.text())
      .then(valid => {
        if (valid !== "true") {
          window.location.href = "index.html";
        } else {
          if (window.location.pathname.includes("admin") && role !== "admin") {
            window.location.href = "index.html";
          }  if (nameSpan && username) {
                      nameSpan.textContent = username;
                      }
                
                          // âœ… Restore the last visited tab
          const savedTab = localStorage.getItem("lastTab") || "users";
          showTab(savedTab);

          // currentTab = "users";
          //  showTab("users");

        }
      });
  }
});

  // === Live Order Refresh Integration ===
let currentTab = localStorage.getItem("lastTab") || "users";


setInterval(() => {
  if (currentTab === "orders" && liveRefreshEnabled && !pauseOrdersRefresh) {
    loadOrders(true);
  }
}, 2000);

let pauseOrdersRefresh = false;

function pauseLiveRefresh() {
  pauseOrdersRefresh = true;
}

function resumeLiveRefresh() {
  setTimeout(() => {
    pauseOrdersRefresh = false;
  }, 1000); // short delay to avoid select issues
}

function toggleLivePreview() {
  const checkbox = document.getElementById("liveToggle");
  liveRefreshEnabled = checkbox.checked;

  if (liveRefreshEnabled && currentTab === "orders") {
    loadOrders(true); // ðŸš€ Immediately fetch new orders once enabled
  }
}

  document.addEventListener("DOMContentLoaded", () => {
    const checkbox = document.getElementById("liveToggle");
    if (checkbox) {
      checkbox.checked = false;
      liveRefreshEnabled = false;
    }
  });


function handleOrderSearch(query) {
  loadOrders(false, query);
}

function clearOrderSearch() {
  document.getElementById("orderSearch").value = "";
  loadOrders(); // Reload all orders
}

</script>


  <script>
    const link = document.getElementById("linkInput").value;

    // Generate QR code
    new QRious({
      element: document.getElementById("qr"),
      value: link,
      size: 160
    });

    function copyLink() {
      const input = document.getElementById("linkInput");
      input.select();
      input.setSelectionRange(0, 99999); // Mobile
      document.execCommand("copy");

      const msg = document.getElementById("copiedMsg");
      msg.classList.remove("hidden");

      // Hide after 2 seconds
      setTimeout(() => msg.classList.add("hidden"), 2000);
    }
  </script>
<script>
function hardRefresh() {
  const url = window.location.href.split('?')[0]; // remove old query if exists
  const cacheBuster = '?v=' + new Date().getTime(); // unique value
  window.location.href = url + cacheBuster;
}
</script>

</body>
</html>
