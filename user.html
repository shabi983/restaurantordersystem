<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css?v=1.0.5">
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
  <meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Client Portal">
  <link rel="manifest" href="/CPAS/roxi112/manifest.json">
  <link rel="icon" href="https://abihasofto.xyz/CPAS/roxi112/icon-512.png" type="image/png">
  <link rel="apple-touch-icon" sizes="152x152" href="https://abihasofto.xyz/CPAS/roxi112/icon-512.png">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
 <meta name="theme-color" content="#0097e1">
  <title>User Dashboard</title>
  <style>
    body {
  font-family: Arial, sans-serif;
  margin: 0;
  background: #f4f4f4;
  overflow-x: hidden; /* ðŸ‘ˆ prevent page-wide horizontal scroll */
}

    .hidden {
      display: none !important;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

   .sidebar-transition {
    transition: transform 0.3s ease-in-out, width 0.3s ease-in-out;
    }
    .content-transition {
      transition: margin-left 0.3s ease-in-out;
    }


  </style>

</head>
<body class="bg-gray-100">

  <!-- Topbar (All Devices) -->
  <div class="text-white flex items-center sticky top-0 z-[9999] justify-between px-4 py-3 bg-[#0097e1]" >
  <div class="text-xl font-bold"><img style="width:70px;" src="https://abihasofto.xyz/CPAS/roxi112/loading.png" alt="Abiha Softo"></div>
    <div class="text-xl font-bold">User Dashboard</div>
    <button onclick="toggleSidebar()" class="space-y-1">
      <i class="fa fa-bars text-2xl"></i>
    </button>
  </div>

  <div class="flex">

    <!-- Sidebar -->
    <aside id="sidebar"
      class="sidebar-transition fixed top-0 left-0 h-full bg-[#0097e1] text-white p-4 space-y-4 w-64 overflow-hidden lg:fixed z-40 h-screen">

      <div id="sidebarContent">

  <img style="width:70px;" src="https://abihasofto.xyz/CPAS/roxi112/loading.png" alt="Abiha Softo">
        <a onclick="showDiv('takeOrders', this)" id="btnTakeOrders" class="nav-link block py-2 px-4 rounded cursor-pointer m-5">Take Orders</a>
        <a onclick="showDiv('commingUpdates', this)" class="nav-link block py-2 px-4 rounded cursor-pointer m-5">Updates</a>
        <a class="block py-2 px-4 hover:bg-red-600 border hover:text-white border-red-700 text-red-700 rounded cursor-pointer m-5" onclick="logout()">Logout</a>
         <span class="text-white-600 text-sm fixed" style="bottom: 5px;"><i>Version 1.0.0</i></span>
      </div>
    </aside>

    <!-- Overlay for mobile/tablet -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-30" onclick="toggleSidebar()"></div>

    <!-- Main content -->
    <main id="mainContent" class="flex-1 p-6 content-transition lg:ml-64 overflow-x-hidden">

    
   <div bis_skin_checked="1" class="flex justify-between">
       <h1 class="text-xl font-bold mb-6 mt-6">Welcome: <span id="UserID" class=" text-green-400 font-thin"></span></h1>
       <button onclick="hardRefresh()" style="color:#0097e1; border:none;"><i class="fa fa-refresh transition-transform duration-300 hover:animate-spin cursor-pointer text-xl" onclick="hardRefresh()" title="Refresh"></i></button></div>
        
  
   <div id="takeOrders" class="p-4 max-w-3xl mx-auto page hidden">
        <!-- Search Box for Menu Grid -->
<div class="mb-4 flex items-center justify-around" >
  <h3 class="text-lg text-center font-bold uppercase m-4">Item Menu</h3>
  <input type="text" placeholder="Search item name..." 
    oninput="filterMenuItems(this.value)" 
    class="w-full md:w-1/3 px-4 py-2 border rounded shadow-sm outline-none" />
        <label class="block mb-2">
      <input type="checkbox" id="previewToggle" onchange="syncLivePreview()" class="mr-2" checked>
      Enable Live Preview
    </label>
</div>


    <!-- ðŸ†• Scrollable Menu Items Grid -->
    <div id="menuGridWrapper" class="max-h-[300px] overflow-y-auto mb-6 pr-1">
      <div id="menuGrid" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></div>
    </div>

<!-- Selected Items Area (Scrollable) -->
<form id="orderForm">
  <div id="selectedItemsWrapper" class="max-h-[200px] overflow-y-auto pr-1">
    <div id="menuItems" class="grid gap-4"></div>
  </div>
</form>


    <textarea id="notes" placeholder="Notes..." class="w-full p-2 border rounded mt-4 outline-none"></textarea>
    <div class="flex gap-2 mt-4">
      <button onclick="submitOrder()" class="bg-[#0097e1] hover:bg-blue-600 text-white px-4 py-2 rounded">Submit</button>
      <button onclick="printReceipt()" class="bg-[#0097e1] hover:bg-blue-600 text-white px-4 py-2 rounded">Print</button>
      <button onclick="clearOrder()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">Reset Customer Preview</button>
    </div>

    <!-- Receipt Popup -->
    <div id="receiptPopup" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-[99999] hidden">
      <div class="bg-white p-6 rounded shadow max-w-md w-full" id="receiptContent">
        <div class="flex justify-between items-center mb-4">
          <img src="AS White.png" alt="Company Logo" class="w-16 h-16 object-contain">
          <div id="qrContainer"></div>
        </div>
        <div id="receiptBody" class="text-sm"></div>
        <div class="text-center mt-4 no-print flex justify-around">
          <button onclick="closeReceipt()" class="text-white bg-red-600 hover:bg-red-700 px-4 py-2 rounded">Cancel</button>
          <button onclick="window.print()" class="bg-[#0097e1] hover:bg-blue-600 text-white px-4 py-2 rounded">ðŸ–¨ Print</button>
        </div>
      </div>
    </div>
</div>

<div id="commingUpdates" class="page hidden">
  <h2>Coming Updates Soon</h2>
</div>

  
<div>
  <p class="mt-3 italic text-center text-gray-500">You can Take, Print & Submit the Orders</p> 
  <p class="text-center uppercase">Powered By<a href="https://abihasofto.xyz/" target="_blank" class="text-[#0097e1] hover:text-blue-700 uppercase"> Abiha Softo </a></p>
  </div>
 
    </main>

 <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script>
function showDiv(id, element) {
  // Hide all content sections
  document.querySelectorAll('.page').forEach(div => div.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');

  // Reset button styles
  document.querySelectorAll('.nav-link').forEach(btn => {
    btn.classList.remove('bg-[#0056b3]', 'text-white');
    btn.classList.add('bg-[#0097e1]', 'text-white');
  });

  // Highlight active button
  element.classList.add('bg-[#0056b3]', 'text-white');
  element.classList.remove('bg-[#0097e1]');

  // Save active tab to localStorage
  localStorage.setItem("activeTab", id);

  // Optional: Hide #comm if on commingUpdates
  if (id === 'commingUpdates') {
    const comm = document.getElementById("comm");
    if (comm) comm.classList.add("hidden");
  }
}

// âœ… Load active tab from localStorage or default to 'takeOrders'
window.addEventListener("DOMContentLoaded", () => {
  const activeTab = localStorage.getItem("activeTab") || "takeOrders";
  const activeBtn = document.querySelector(`[onclick*="${activeTab}"]`);
  if (activeBtn) {
    showDiv(activeTab, activeBtn);
  }
});
</script>


<script>
  let sidebarOpen = window.innerWidth >= 1024;

  function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const sidebarContent = document.getElementById('sidebarContent');
    const overlay = document.getElementById('overlay');
    const mainContent = document.getElementById('mainContent');

    sidebar.classList.toggle('w-64');
    sidebar.classList.toggle('w-0');
    sidebar.classList.toggle('-translate-x-full');

    sidebarContent.classList.toggle('opacity-0');
    sidebarContent.classList.toggle('pointer-events-none');

    if (window.innerWidth >= 1024) {
      mainContent.classList.toggle('lg:ml-64');
    } else {
      overlay.classList.toggle('hidden');
    }

    sidebarOpen = !sidebarOpen;
  }

  // âœ… Fix: ensure sidebar stays hidden on mobile/tab when page loads
  document.addEventListener('DOMContentLoaded', () => {
    if (window.innerWidth < 1024) {
      const sidebar = document.getElementById('sidebar');
      const sidebarContent = document.getElementById('sidebarContent');
      const overlay = document.getElementById('overlay');

      sidebar.classList.add('-translate-x-full');
      sidebar.classList.add('w-0');
      sidebar.classList.remove('w-64');

      sidebarContent.classList.add('opacity-0');
      sidebarContent.classList.add('pointer-events-none');

      overlay.classList.add('hidden');
    } 
  }); 



</script>



<script>
   const API_URL = "https://script.google.com/macros/s/AKfycby_dcdxa11mxd14S1Uvd7m9hQR-FKgGh3jYMu0emhBFiw5FAbpM7oa7smACeZUJQMod0A/exec";
      let fullMenu = [], selectedItemsMap = {};

        // âœ… SESSION + ROLE GUARD (prevent unauthorized access to user.html)
  window.addEventListener("DOMContentLoaded", () => {
    const token = localStorage.getItem("session");
    const role = localStorage.getItem("role");
    const nameSpan = document.getElementById("UserID");
    const username = localStorage.getItem("username");

    if (!token || !role) {
      window.location.href = "index.html"; // Not logged in
    } else if (role !== "user") {
      window.location.href = "index.html"; // Not a user
    } else {if (nameSpan && username) {
     nameSpan.textContent = username;} }

                               // âœ… Restore the last visited tab
          const savedTab = localStorage.getItem("lastTab") || "users";
          showTab(savedTab);
  });

 
  function logout() {
    localStorage.removeItem("userEmail");
    localStorage.removeItem("userPassword");
    window.location.href = "index.html#login";
  }


        window.onload = () => {
        fetch(API_URL + '?action=getMenu')
          .then(res => res.json())
          .then(data => {
            fullMenu = data;
            renderMenuGrid();
          });
      };

      function renderMenuGrid() {
        const container = document.getElementById("menuGrid");
        container.innerHTML = fullMenu.map(item => `
          <div onclick="addItem('${item["Item Name"]}')" class="border rounded p-3 bg-white shadow hover:shadow-md cursor-pointer transition">
            <div class="font-bold text-lg">${item["Item Name"]}</div>
            <div class="text-sm text-gray-600">$ ${item.Price}</div>
            ${item.Sauces ? `<div class="text-xs text-gray-500 mt-1">Sauces: ${item.Sauces}</div>` : ''}
            ${item.Extras ? `<div class="text-xs text-gray-500">Extras: ${item.Extras}</div>` : ''}
          </div>
        `).join('');
      }

      function addItem(itemName) {
        if (selectedItemsMap[itemName]) return;
        const item = fullMenu.find(i => i["Item Name"] === itemName);
        selectedItemsMap[itemName] = item;
        renderSelectedItems();
      }

      function removeItem(itemName) {
        delete selectedItemsMap[itemName];
        renderSelectedItems();
      }


function filterMenuItems(query) {
  const cards = document.querySelectorAll('#menuGrid > div');
  const lowerQuery = query.toLowerCase();

  cards.forEach(card => {
    const text = card.innerText.toLowerCase();
    card.style.display = text.includes(lowerQuery) ? '' : 'none';
  });
}



function renderSelectedItems() {
  // Step 1: Save current checkbox states
  const savedSauces = {};
  const savedExtras = {};

  document.querySelectorAll(".sauce-input:checked").forEach(input => {
    const item = input.dataset.item;
    if (!savedSauces[item]) savedSauces[item] = [];
    savedSauces[item].push(input.value);
  });

  document.querySelectorAll(".extra-input:checked").forEach(input => {
    const item = input.dataset.item;
    if (!savedExtras[item]) savedExtras[item] = [];
    savedExtras[item].push(input.value);
  });

  // Step 2: Rebuild the item cards
  let html = "";
  for (let itemName in selectedItemsMap) {
    const item = selectedItemsMap[itemName];
    html += `
      <div class="border rounded p-3 bg-white shadow relative">
        <button onclick="removeItem('${itemName}')" class="absolute top-1 right-2 text-red-500 font-bold text-lg hover:text-red-700">Ã—</button>
        <div class="font-bold">${item["Item Name"]} <span class="text-gray-500">($ ${item.Price})</span></div>
    `;

    if (item.Sauces) {
      html += `<label class="block mt-2 text-sm font-medium">Sauces:</label><div class="grid grid-cols-2 gap-2 mt-1">`;
      html += item.Sauces.split(',').map(s => {
        const checked = savedSauces[itemName]?.includes(s.trim()) ? "checked" : "";
        return `
          <label class="inline-flex items-center">
            <input type="checkbox" class="sauce-input mr-2" data-item="${itemName}" value="${s.trim()}" ${checked}> ${s.trim()}
          </label>`;
      }).join('');
      html += `</div>`;
    }

    if (item.Extras) {
      html += `<label class="block mt-2 text-sm font-medium">Extras:</label><div class="grid grid-cols-2 gap-2 mt-1">`;
      html += item.Extras.split(',').map(e => {
        const checked = savedExtras[itemName]?.includes(e.trim()) ? "checked" : "";
        return `
          <label class="inline-flex items-center">
            <input type="checkbox" class="extra-input mr-2" data-item="${itemName}" value="${e.trim()}" ${checked}> ${e.trim()}
          </label>`;
      }).join('');
      html += `</div>`;
    }

    html += `</div>`;
  }

  // Step 3: Inject HTML and attach listeners
  document.getElementById("menuItems").innerHTML = html;

  document.querySelectorAll(".sauce-input, .extra-input").forEach(input => {
    input.addEventListener("change", () => {
      syncLivePreview();
    });
  });

  document.getElementById("notes").addEventListener("input", () => {
    syncLivePreview();
  });

  syncLivePreview();
}


      function submitOrder() {
        const order = [], user = localStorage.getItem("username") || "anonymous";
        let total = 0;
        for (let itemName in selectedItemsMap) {
          const item = selectedItemsMap[itemName];
          const sauces = Array.from(document.querySelectorAll(`.sauce-input[data-item='${itemName}']:checked`)).map(cb => cb.value);
          const extras = Array.from(document.querySelectorAll(`.extra-input[data-item='${itemName}']:checked`)).map(cb => cb.value);
          total += parseFloat(item.Price);
          order.push({ name: itemName, price: item.Price, sauces, extras });
        }
        const notes = document.getElementById("notes").value;
        const payload = { user, items: order, total, notes, preview: document.getElementById("previewToggle").checked ? "true" : "false" };
        fetch(API_URL, {
          method: "POST",
          body: new URLSearchParams({ action: "submitOrder", order: JSON.stringify(payload) })
        }).then(res => res.json()).then(data => {
          alert("âœ… Order submitted successfully!");
          clearOrder();
        });
      }

      function syncLivePreview() {
        let preview = [], total = 0;
        for (let itemName in selectedItemsMap) {
          const item = selectedItemsMap[itemName];
          const sauces = Array.from(document.querySelectorAll(`.sauce-input[data-item='${itemName}']:checked`)).map(cb => cb.value);
          const extras = Array.from(document.querySelectorAll(`.extra-input[data-item='${itemName}']:checked`)).map(cb => cb.value);
          total += parseFloat(item.Price);
          preview.push({ name: itemName, price: item.Price, sauces, extras });
        }
        const notes = document.getElementById("notes").value;
        if (document.getElementById("previewToggle").checked) {
          fetch(API_URL, {
            method: "POST",
            body: new URLSearchParams({ action: "setLivePreview", data: JSON.stringify({ items: preview, total, notes }) })
          });
        }
      }

      function clearOrder() {
        selectedItemsMap = {};
        document.getElementById("menuItems").innerHTML = "";
        document.getElementById("notes").value = "";
        syncLivePreview();
      }

      function printReceipt() {
        const items = [], receiptBody = document.getElementById("receiptBody");
        let total = 0;
        for (let itemName in selectedItemsMap) {
          const item = selectedItemsMap[itemName];
          const sauces = Array.from(document.querySelectorAll(`.sauce-input[data-item='${itemName}']:checked`)).map(cb => cb.value).join(", ") || "-";
          const extras = Array.from(document.querySelectorAll(`.extra-input[data-item='${itemName}']:checked`)).map(cb => cb.value).join(", ") || "-";
          total += parseFloat(item.Price);
          items.push({ itemName, price: item.Price, sauces, extras });
        }
        let html = `<table class="w-full text-sm border-b mb-2"><tr class="font-semibold border-b"><th>Item</th><th>Sauce</th><th>Extra</th><th>Rs</th></tr>`;
        items.forEach(i => {
          html += `<tr><td>${i.itemName}</td><td>${i.sauces}</td><td>${i.extras}</td><td>${i.price}</td></tr>`;
        });
        html += `</table><p class="font-semibold mt-2">Total: $ ${total}</p>`;
        const notes = document.getElementById("notes").value;
        if (notes) html += `<p class="italic text-sm mt-1">Note: ${notes}</p>`;
        receiptBody.innerHTML = html;
        const qr = new QRious({ element: document.createElement("canvas"), value: "https://google.com", size: 80 });
        const qrContainer = document.getElementById("qrContainer");
        qrContainer.innerHTML = "";
        qrContainer.appendChild(qr.element);
        document.getElementById("receiptPopup").classList.remove("hidden");
      }

      function closeReceipt() {
        document.getElementById("receiptPopup").classList.add("hidden");
      }

</script>

<script>
function hardRefresh() {
  const url = window.location.href.split('?')[0]; // remove old query if exists
  const cacheBuster = '?v=' + new Date().getTime(); // unique value
  window.location.href = url + cacheBuster;
}
</script>


  <!-- Extra styles -->
    <style>
      @media print {.no-print { display: none !important; }}
  #menuGridWrapper::-webkit-scrollbar {
    width: 6px;
  }
  #menuGridWrapper::-webkit-scrollbar-thumb {
    background-color: #cbd5e0;
    border-radius: 3px;
  }

  #selectedItemsWrapper::-webkit-scrollbar {
    width: 6px;
  }
  #selectedItemsWrapper::-webkit-scrollbar-thumb {
    background-color: #cbd5e0;
    border-radius: 4px;
  }

    </style>

  <!-- Loader -->
  <div id="globalLoader" class="fixed w-[200px] inset-0 z-50 flex items-center justify-center hidden">
    <div class="relative flex items-center justify-center" style="position: absolute; bottom: 60px; right: 30px;">
      <div class="absolute w-28 h-28 border-4 border-[#ffffff] border-dashed rounded-full animate-spin"></div>
      <img class="animate-zoom" style=" max-width: 88px;" src="https://abihasofto.xyz/CPAS/roxi112/loading.png" alt="Abiha Softo">
    </div>
  </div>


    <style>
      @keyframes zoom {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.15); }
      }
      .animate-zoom {
        animation: zoom 1s ease-in-out infinite;
      }
    </style>

    <script>
      function showLoader() {
        document.getElementById("globalLoader").classList.remove("hidden");
      }
      function hideLoader() {
        document.getElementById("globalLoader").classList.add("hidden");
      }
      const originalFetch = window.fetch;
      window.fetch = function (...args) {
        showLoader();
        return originalFetch(...args)
          .then(res => {
            hideLoader();
            return res;
          })
          .catch(err => {
            hideLoader();
            throw err;
          });
      };
    </script>




</body>
</html>
